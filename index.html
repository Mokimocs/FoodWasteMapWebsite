<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Unity Web Player | Waste Map Website</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <style>
      :root {
        --panel-radius: 18px;
        --panel-padding: 16px;
      }

      /* Header area */
      #page-header {
        padding: 12px 16px;
      }

      /* Make the Unity area responsive + centered */
      #unity-container {
        width: min(1000px, 100%);
        margin: 0 auto;
      }

      /* Make the canvas scale to the container */
      #unity-canvas {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Backdrop behind the bottom panel */
      #panel-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 9998;
      }

      #panel-backdrop.open {
        opacity: 1;
        pointer-events: auto;
      }

      /* Bottom sheet panel */
      #info-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;

        height: min(55vh, 520px);
        background: #fff;

        border-top-left-radius: var(--panel-radius);
        border-top-right-radius: var(--panel-radius);
        box-shadow: 0 -12px 35px rgba(0, 0, 0, 0.25);

        transform: translateY(110%);
        transition: transform 0.3s ease;

        padding: var(--panel-padding);
        box-sizing: border-box;

        z-index: 9999;
        display: flex;
        flex-direction: column;
      }

      #info-panel.open {
        transform: translateY(0);
      }

      /* Panel header row */
      #panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
      }

      #country-title {
        margin: 0;
        font-size: 22px;
        line-height: 1.2;
      }

      /* Close button */
      #close-panel {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.06);
        cursor: pointer;
        font-size: 26px;
        line-height: 1;
      }

      #close-panel:active {
        transform: scale(0.97);
      }

      /* Scrollable content */
      #panel-content {
        padding-top: 12px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        flex: 1;
      }

      #country-body {
        margin: 0;
        font-size: 16px;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.85);
      }

      /* -------------------------
         SPOT FULL SCREEN OVERLAY
         ------------------------- */
      #spot-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 10000;
      }

      #spot-overlay.open {
        display: flex;
      }

      #spot-card {
        width: min(820px, 100%);
        background: rgba(255, 255, 255, 0.92);
        border-radius: 22px;
        padding: 20px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(6px);
      }

      #spot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      #spot-header h1 {
        margin: 0;
        font-size: 26px;
      }

      #spot-close {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        font-size: 26px;
        cursor: pointer;
      }

      #spot-actions {
        display: grid;
        gap: 12px;
        margin: 14px 0;
      }

      .spot-choice {
        text-align: left;
        padding: 14px 16px;
        border: none;
        border-radius: 14px;
        background: rgba(120, 190, 255, 0.18);
        cursor: pointer;
        font-size: 16px;
      }

      .spot-choice:active {
        transform: scale(0.99);
      }

      #spot-footer-note {
        margin: 10px 0 0;
        color: rgba(0, 0, 0, 0.75);
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <div id="page-header">
      <h1 style="margin: 0;">Food Waste Across the Globe</h1>
      <p style="margin: 6px 0 0;">Tap a country on the map.</p>
    </div>

    <!-- Backdrop for bottom panel -->
    <div id="panel-backdrop"></div>

    <!-- Bottom info panel -->
    <div id="info-panel">
      <div id="panel-header">
        <h2 id="country-title"></h2>
        <button id="close-panel" aria-label="Close panel">�</button>
      </div>

      <div id="panel-content">
        <p id="country-body"></p>
      </div>
    </div>

    <!-- SPOT overlay -->
    <div id="spot-overlay">
      <div id="spot-card">
        <div id="spot-header">
          <h1>SPOT � Our Table</h1>
          <button id="spot-close" aria-label="Close">�</button>
        </div>

        <p><strong>At SPOT, we waste about 250g</strong> of food per day in the restaurant.</p>
        <p>
          That�s roughly the same as the weekly food waste of <strong>Y households</strong>
          in one of the countries you just visited.
        </p>
        <p><em>Next lunch, what�s one small thing you might do differently?</em></p>

        <div id="spot-actions">
          <button class="spot-choice" data-choice="smaller">Take smaller portions first</button>
          <button class="spot-choice" data-choice="leftovers">Save leftovers for later</button>
          <button class="spot-choice" data-choice="veggies">Finish veggies before dessert</button>
        </div>

        <p id="spot-footer-note">
          If 100 people finished their veggies more often, we�d cut both food and resource waste linked to vegetables.
        </p>
      </div>
    </div>

    <!-- Unity container -->
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="1280" height="720" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Waste Map Website</div>
      </div>
    </div>

    <script>
      // -------------------------
      // Country data
      // -------------------------
      let countryData = {};

      fetch("countries.json")
        .then((response) => response.json())
        .then((data) => {
          countryData = data;
          console.log("Country data loaded:", countryData);
        })
        .catch((error) => {
          console.error("Failed to load countries.json", error);
        });

      // -------------------------
      // Track progress (EDIT THIS LIST)
      // -------------------------
      const visitedCountries = new Set();

      // IMPORTANT: put exactly your clickable country IDs here
      const requiredCountries = ["PT", "MX", "IN", "NI"];

      // When true, SPOT overlay will show after the player closes the panel
      let allCountriesCompleted = false;

      // -------------------------
      // Bottom panel open/close
      // -------------------------
      function closePanel() {
        document.getElementById("info-panel").classList.remove("open");
        document.getElementById("panel-backdrop").classList.remove("open");

        // If all countries were completed, show SPOT AFTER closing animation
        if (allCountriesCompleted) {
          allCountriesCompleted = false; // prevent repeat
          setTimeout(showSpotOverlay, 300); // matches your CSS transition
        }
      }

      // -------------------------
      // SPOT overlay open/close
      // -------------------------
      function showSpotOverlay() {
        document.getElementById("spot-overlay").classList.add("open");
      }

      function hideSpotOverlay() {
        document.getElementById("spot-overlay").classList.remove("open");
      }

      document.getElementById("spot-close").onclick = hideSpotOverlay;
      document.getElementById("spot-overlay").onclick = (e) => {
        if (e.target.id === "spot-overlay") hideSpotOverlay();
      };

      document.querySelectorAll(".spot-choice").forEach((btn) => {
        btn.onclick = () => {
          const choice = btn.dataset.choice;
          console.log("Player choice:", choice);

          // For now: close overlay after choice
          hideSpotOverlay();

          // Later (optional): send choice back into Unity
          // unityInstance.SendMessage("SomeGameObject", "OnSpotChoice", choice);
        };
      });

      // -------------------------
      // Unity calls this (via your .jslib bridge)
      // -------------------------
      window.openPanel = function (countryId) {
        visitedCountries.add(countryId);

        // Fill info panel content
        if (!countryData || Object.keys(countryData).length === 0) {
          document.getElementById("country-title").textContent = "Loading...";
          document.getElementById("country-body").textContent =
            "Please try again in a second.";
        } else {
          const info = countryData[countryId];

          document.getElementById("country-title").textContent = info
            ? info.name
            : "Unknown Country";

          document.getElementById("country-body").textContent = info
            ? info.body
            : "No data found for: " + countryId;
        }

        document.getElementById("info-panel").classList.add("open");
        document.getElementById("panel-backdrop").classList.add("open");

        // Mark completion (but DO NOT show SPOT yet)
        const done = requiredCountries.every((id) => visitedCountries.has(id));
        if (done) {
          allCountriesCompleted = true;
        }
      };

      document.getElementById("close-panel").onclick = closePanel;
      document.getElementById("panel-backdrop").onclick = closePanel;

      // -------------------------
      // UNITY LOADER
      // -------------------------
      var canvas = document.querySelector("#unity-canvas");

      function unityShowBanner(msg, type) {
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length
            ? "block"
            : "none";
        }
        var div = document.createElement("div");
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == "error") div.style = "background: red; padding: 10px;";
        else {
          if (type == "warning") div.style = "background: yellow; padding: 10px;";
          setTimeout(function () {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

     var buildUrl = "Build";
var loaderUrl = buildUrl + "/BuildWeb.loader.js";
var config = {
  arguments: [],
  dataUrl: buildUrl + "/BuildWeb.data",
  frameworkUrl: buildUrl + "/BuildWeb.framework.js",
  codeUrl: buildUrl + "/BuildWeb.wasm",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "DefaultCompany",
  productName: "Waste Map Website",
  productVersion: "1.0",
  showBanner: unityShowBanner,
};


      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement("meta");
        meta.name = "viewport";
        meta.content =
          "width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes";
        document.getElementsByTagName("head")[0].appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";

        // Optional performance tweak:
        // config.devicePixelRatio = 1;
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width =
            100 * progress + "%";
        })
          .then((unityInstance) => {
            document.querySelector("#unity-loading-bar").style.display = "none";
            document.querySelector("#unity-fullscreen-button").onclick = () => {
              unityInstance.SetFullscreen(1);
            };
          })
          .catch((message) => {
            alert(message);
          });
      };

      document.body.appendChild(script);
    </script>
  </body>
</html>
